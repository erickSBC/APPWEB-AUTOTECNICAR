<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti칩n de Categor칤as - D'Cesar</title>

  <style>
    :root {
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.08);
      --danger: #ef4444;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
      --transition: all 0.18s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      margin-left: 260px !important;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .app-main {
      flex: 1;
      padding: 24px 28px 40px;
      overflow-x: hidden;
    }

    /* ===== HEADER DE P츼GINA ===== */

    .page-breadcrumb {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .page-breadcrumb span {
      color: var(--text-main);
      font-weight: 500;
    }

    .page-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }


    .page-header-actions {
      display: flex;
      gap: 12px;
      align-items: start;
    }

    .search-box {
      position: relative;
      min-width: 230px;
    }

    .search-box input {
      width: 100%;
      border: .5px solid rgb(158, 158, 168);
      padding: 9px 14px;
      padding-left: 34px;
      font-size: 14px;
      outline: none;
      background: #ffffff;
    }

    .search-box input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .search-box::before {
      content: "游댌";
      position: absolute;
      font-size: 14px;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }

    .btn {
      .btn {
        appearance: none;
        border: none;
        border-radius: 999px;
        font-size: 14px;
        padding: 9px 18px;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        white-space: nowrap;
        transition: none;

      }
    }

    .btn-primary {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.28);
    }

    .btn-primary:hover {
      box-shadow: 0 16px 45px rgba(15, 23, 42, 0.32);
    }

    .btn-sm {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: none;
    }

    .btn-outline {
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: #111827;
    }

    .btn-outline:hover {
      background: #f3f4f6;
    }

    .btn-danger {
      background: var(--danger);
      color: #ffffff;
    }

    .btn-danger:hover {
      filter: brightness(0.95);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: var(--border-soft);
      background: #f9fafb;
    }

    /* ===== SECCI칍N PRINCIPAL ===== */

    .cats-page-title {
      font-size: 26px;
      margin: 22px 0 18px;
      font-weight: 700;
    }

    .cats-layout {

      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .cats-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 12px;
    }

    .card-header-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .card-header-meta {
      font-size: 13px;
      color: var(--text-muted);
      text-align: right;
    }

    /* ===== TABLA CATEGOR칈AS ===== */

    .cats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    .cats-table thead tr {
      border-bottom: 1px solid var(--border-soft);
    }

    .cats-table th,
    .cats-table td {
      padding: 10px 8px;
      text-align: left;
    }

    .cats-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      font-weight: 600;
    }

    .cats-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }

    .cats-table tbody tr:last-child {
      border-bottom: none;
    }

    .cat-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
    }

    .cat-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .cat-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge-count {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfeff;
      color: #0891b2;
    }

    .cell-actions {
      display: flex;
      gap: 6px;
    }



    /* ===== MODAL CREAR/EDITAR ===== */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 20px 16px;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 24px 65px rgba(15, 23, 42, 0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .modal-description {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .form-field label {
      color: var(--text-muted);
    }

    .form-field input,
    .form-field textarea {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      font-size: 14px;
      outline: none;
      background: #f9fafb;
      transition: var(--transition);
      resize: vertical;
    }

    .form-field input:focus,
    .form-field textarea:focus {
      background: #ffffff;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    @media (max-width: 640px) {
      .page-title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .page-header-actions {
        display: flex;
        gap: 12px;
        align-items: start;

      }

      .search-box {
        flex: 1;
      }


    }

    /* Overlay espec칤fico del modal de categorias */
    #catModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* Cuando est치 abierto */
    #catModal.is-open {
      display: flex !important;
    }

    /* Contenedor del contenido del modal */
    #catModal .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 20px 16px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 24px 65px rgba(15, 23, 42, 0.35);
      display: block !important;
      /* por si alg칰n CSS lo pone en none */
      position: relative;
      z-index: 10000;
      height: auto;
    }
  </style>
</head>

<body>

  <div class="app-layout">
    <!-- SIDEBAR -->
    <div id="sdbar"></div>
    <script>
      fetch("components/sidebar.html")
        .then(r => r.text())
        .then(h => (document.getElementById("sdbar").innerHTML = h));
    </script>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="app-main">
      <div class="page-breadcrumb">
        Dashboard / <span>Categor칤as</span>
      </div>

      <div class="page-title-row">
        <h1 class="page-title">Gesti칩n de Categor칤as</h1>

        <div class="page-header-actions">
          <div class="search-box">
            <input id="searchInput" type="text" placeholder="Buscar categor칤a" />
          </div>
          <button id="btnNewCategory" class="btn btn-primary">
            + Nueva Categor칤a
          </button>
        </div>
      </div>

      <h2 class="cats-page-title">Lista de Categor칤as</h2>

      <div class="cats-layout">
        <!-- LISTA CATEGOR칈AS -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-header-title">Categor칤as registradas</div>
              <div class="card-subtitle">
                Total: <span id="totalCategorias">0</span> categor칤as
              </div>
            </div>
            <div class="card-header-meta">
              칔ltima actualizaci칩n: <span id="lastUpdate">-</span>
            </div>
          </div>

          <table class="cats-table">
            <thead>
              <tr>
                <th>Categor칤a</th>
                <th>Descripci칩n</th>
                <th>Productos</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="catsTbody">
              <!-- filas generadas por JS -->
            </tbody>
          </table>
        </section>


      </div>
    </main>
  </div>

  <!-- MODAL CREAR / EDITAR CATEGOR칈A -->
  <div id="catModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div id="modalTitle" class="modal-title">Nueva Categor칤a</div>
          <div id="modalSubtitle" class="modal-description">
            Completa los datos de la categor칤a.
          </div>
        </div>
        <button class="modal-close" type="button" id="btnCloseModal">&times;</button>
      </div>

      <div class="modal-body">
        <form id="catForm">
          <input type="hidden" id="catId" />

          <div class="form-field">
            <label for="catNombre">Nombre</label>
            <input type="text" id="catNombre" required placeholder="Ej: Alternadores" />
          </div>

          <div class="form-field">
            <label for="catDescripcion">Descripci칩n</label>
            <textarea id="catDescripcion" rows="3"
              placeholder="Describe el tipo de productos que agrupa esta categor칤a."></textarea>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-ghost btn-sm" id="btnCancelModal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary btn-sm">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG API ===
    const API_BASE = 'http://localhost:3000'; // ajusta si tu backend est치 en otro host/puerto
    const API_CATEGORIAS = API_BASE + '/categorias';

    // === ESTADO ===
    let categorias = [];
    let filteredCategorias = [];
    let modalMode = 'create'; // 'create' | 'edit'

    // === DOM ===
    const catsTbody = document.getElementById('catsTbody');
    const totalCategoriasSpan = document.getElementById('totalCategorias');
    const lastUpdateSpan = document.getElementById('lastUpdate');
    const searchInput = document.getElementById('searchInput');
    const btnNewCategory = document.getElementById('btnNewCategory');

    const catModal = document.getElementById('catModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancelModal = document.getElementById('btnCancelModal');

    const catForm = document.getElementById('catForm');
    const inputId = document.getElementById('catId');
    const inputNombre = document.getElementById('catNombre');
    const inputDescripcion = document.getElementById('catDescripcion');

    // === UTILIDADES ===
    function shortDateTime(date) {
      const d = new Date(date);
      if (Number.isNaN(d.getTime())) return '-';
      const h = d.getHours().toString().padStart(2, '0');
      const m = d.getMinutes().toString().padStart(2, '0');
      return `${d.toLocaleDateString()} ${h}:${m}`;
    }

    function catAvatar(nombre) {
      const n = (nombre || '').trim();
      if (!n) return 'C';
      return n.charAt(0).toUpperCase();
    }

    function openModal(mode, categoria) {
      modalMode = mode;

      if (mode === 'create') {
        modalTitle.textContent = 'Nueva Categor칤a';
        modalSubtitle.textContent = 'Completa los datos para registrar una nueva categor칤a.';
        catForm.reset();
        inputId.value = '';
      } else if (mode === 'edit' && categoria) {
        modalTitle.textContent = 'Editar Categor칤a';
        modalSubtitle.textContent = 'Actualiza los datos de la categor칤a seleccionada.';
        inputId.value = categoria.id_categoria;
        inputNombre.value = categoria.nombre ?? '';
        inputDescripcion.value = categoria.descripcion ?? '';
      }

      catModal.classList.add('is-open');
    }

    function closeModal() {
      catModal.classList.remove('is-open');
    }

    // === RENDER ===
    function renderCategorias(list) {
      catsTbody.innerHTML = '';

      list.forEach(cat => {
        const tr = document.createElement('tr');
        tr.dataset.id = cat.id_categoria;

        const totalProductos = Array.isArray(cat.productos) ? cat.productos.length : 0;

        tr.innerHTML = `
        <td>
          <div class="cat-cell">
            <div class="cat-avatar">${catAvatar(cat.nombre)}</div>
            <div>
              <div class="cat-name">${cat.nombre ?? ''}</div>
            </div>
          </div>
        </td>
        <td>${cat.descripcion ?? ''}</td>
        <td>
          <span class="badge-count">${totalProductos} prod.</span>
        </td>
        <td>
          <div class="cell-actions">
            <button type="button" class="btn btn-outline btn-sm btn-edit">Editar</button>
            <button type="button" class="btn btn-danger btn-sm btn-delete">Eliminar</button>
          </div>
        </td>
      `;

        catsTbody.appendChild(tr);
      });

      totalCategoriasSpan.textContent = list.length;
      lastUpdateSpan.textContent = shortDateTime(new Date());
    }

    // === API ===
    async function fetchCategorias() {
      try {
        const res = await fetch(API_CATEGORIAS);
        if (!res.ok) throw new Error('Error al obtener categor칤as');
        categorias = await res.json();
        filteredCategorias = categorias.slice();
        renderCategorias(filteredCategorias);
      } catch (err) {
        console.error(err);
        alert('No se pudieron cargar las categor칤as.');
      }
    }

    async function fetchCategoriaPorId(id) {
      const res = await fetch(`${API_CATEGORIAS}/${id}`);
      if (!res.ok) throw new Error('No se pudo obtener la categor칤a');
      return res.json();
    }

    async function crearCategoria(payload) {
      const res = await fetch(API_CATEGORIAS, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(localStorage.getItem("token") && { 'Authorization': `Bearer ${localStorage.getItem("token")}` }),
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al crear categor칤a');
      }
      return res.json();
    }

    async function actualizarCategoria(id, payload) {
      const res = await fetch(`${API_CATEGORIAS}/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...(localStorage.getItem("token") && { 'Authorization': `Bearer ${localStorage.getItem("token")}` }),
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al actualizar categor칤a');
      }
      return res.json();
    }

    async function eliminarCategoria(id) {
      const res = await fetch(`${API_CATEGORIAS}/${id}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem("token")}`,   // 游녣 AQU칈 se manda el token
          }
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al eliminar categor칤a');
      }
      return res.json();
    }

    // === EVENTOS ===

    // Abrir modal nueva categor칤a
    btnNewCategory.addEventListener('click', () => openModal('create'));

    // Cerrar modal
    btnCloseModal.addEventListener('click', closeModal);
    btnCancelModal.addEventListener('click', closeModal);
    catModal.addEventListener('click', (e) => {
      if (e.target === catModal) closeModal();
    });

    // Submit formulario
    catForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        nombre: inputNombre.value.trim(),
        descripcion: inputDescripcion.value.trim(),
      };

      if (!payload.nombre) {
        alert('El nombre de la categor칤a es obligatorio.');
        return;
      }

      try {
        if (modalMode === 'create') {
          await crearCategoria(payload);
        } else if (modalMode === 'edit') {
          await actualizarCategoria(inputId.value, payload);
        }
        closeModal();
        await fetchCategorias();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Error al guardar la categor칤a.');
      }
    });

    // Editar / Eliminar (delegado desde tbody)
    catsTbody.addEventListener('click', async (e) => {
      const row = e.target.closest('tr');
      if (!row) return;
      const id = row.dataset.id;

      if (e.target.classList.contains('btn-edit')) {
        try {
          const categoria = await fetchCategoriaPorId(id);
          openModal('edit', categoria);
        } catch (err) {
          console.error(err);
          alert('No se pudo cargar la categor칤a seleccionada.');
        }
      }

      if (e.target.classList.contains('btn-delete')) {
        const ok = confirm('쯉eguro que deseas eliminar esta categor칤a?');
        if (!ok) return;
        try {
          await eliminarCategoria(id);
          await fetchCategorias();
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar la categor칤a.');
        }
      }
    });

    // B칰squeda local por nombre
    let searchTimeout = null;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const term = searchInput.value.trim().toLowerCase();
        if (!term) {
          filteredCategorias = categorias.slice();
        } else {
          filteredCategorias = categorias.filter(cat =>
            (cat.nombre || '').toLowerCase().includes(term)
          );
        }
        renderCategorias(filteredCategorias);
      }, 250);
    });

    // === INICIALIZAR ===
    fetchCategorias();
  </script>
  <script src="./components/sidebar.js"></script>
</body>

</html>