<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti칩n de Productos - D'Cesar</title>

  <style>
    :root {
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.08);
      --danger: #ef4444;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
      --transition: all 0.18s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      margin-left: 260px !important;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    /* Layout general: sidebar + contenido */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .app-main {
      flex: 1;
      padding: 24px 28px 40px;
      overflow-x: hidden;
    }

    /* ===== HEADER DE P츼GINA ===== */

    .page-breadcrumb {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .page-breadcrumb span {
      color: var(--text-main);
      font-weight: 500;
    }

    .page-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }


    .page-header-actions {
      display: flex;
      gap: 12px;
      align-items: start;
    }

    .search-box {
      position: relative;
      min-width: 230px;
    }

    .search-box input {
      width: 100%;
      border: .5px solid rgb(158, 158, 168);
      padding: 9px 14px;
      padding-left: 34px;
      font-size: 14px;
      outline: none;
      background: #ffffff;
    }

    .search-box input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .search-box::before {
      content: "游댌";
      position: absolute;
      font-size: 14px;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      padding: 9px 18px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-primary {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.28);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 45px rgba(15, 23, 42, 0.32);
    }

    .btn-sm {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: none;
    }

    .btn-outline {
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
    }

    .btn-outline:hover {
      background: #f3f4f6;
    }

    .btn-danger {
      background: var(--danger);
      color: #ffffff;
    }

    .btn-danger:hover {
      filter: brightness(0.95);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: var(--border-soft);
      background: #f9fafb;
    }

    /* ===== SECCI칍N PRINCIPAL ===== */

    .products-page-title {
      font-size: 26px;
      margin: 22px 0 18px;
      font-weight: 700;
    }

    .products-layout {

      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .products-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 12px;
    }

    .card-header-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .card-header-meta {
      font-size: 13px;
      color: var(--text-muted);
      text-align: right;
    }

    /* ===== FILTROS ===== */

    .filters-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .filters-row select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      background: #f9fafb;
      outline: none;
      transition: var(--transition);
    }

    .filters-row select:focus {
      background: #ffffff;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    /* ===== TABLA PRODUCTOS ===== */

    .products-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    .products-table thead tr {
      border-bottom: 1px solid var(--border-soft);
    }

    .products-table th,
    .products-table td {
      padding: 10px 8px;
      text-align: left;
    }

    .products-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      font-weight: 600;
    }

    .products-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }

    .products-table tbody tr:last-child {
      border-bottom: none;
    }

    .product-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-avatar {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 600;
      color: #374151;
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .product-category {
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge-category {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .price-cell {
      font-weight: 600;
    }

    .stock-low {
      color: #b91c1c;
      font-weight: 600;
    }

    .cell-actions {
      display: flex;
      gap: 6px;
    }

    /* ===== PAGINACI칍N ===== */

    .pagination {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .pagination button[disabled] {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }



    /* ===== MODAL CREAR / EDITAR PRODUCTO ===== */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 20px 16px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 24px 65px rgba(15, 23, 42, 0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .modal-description {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .form-field label {
      color: var(--text-muted);
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      font-size: 14px;
      outline: none;
      background: #f9fafb;
      transition: var(--transition);
      resize: vertical;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      background: #ffffff;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    @media (max-width: 640px) {
      .page-title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .page-header-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .search-box {
        flex: 1;
      }
    }

    /* Overlay espec칤fico del modal de clientes */
    #productModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* Cuando est치 abierto */
    #productModal.is-open {
      display: flex !important;
    }

    /* Contenedor del contenido del modal */
    #productModal .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 20px 16px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 24px 65px rgba(15, 23, 42, 0.35);
      display: block !important;
      /* por si alg칰n CSS lo pone en none */
      position: relative;
      z-index: 10000;
      height: auto;
    }
  </style>
</head>

<body>

  <div class="app-layout">
    <!-- SIDEBAR -->
    <div id="sdbar"></div>
    <script>
      // carga el sidebar com칰n
      fetch("components/sidebar.html")
        .then(r => r.text())
        .then(h => (document.getElementById("sdbar").innerHTML = h));
    </script>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="app-main">
      <div class="page-breadcrumb">
        Dashboard / <span>Productos</span>
      </div>

      <div class="page-title-row">
        <h1 class="page-title">Gesti칩n de Productos</h1>

        <div class="page-header-actions">
          <div class="search-box">
            <input id="searchInput" type="text" placeholder="Buscar producto" />
          </div>
          <button id="btnNewProduct" class="btn btn-primary">
            + Nuevo Producto
          </button>
        </div>
      </div>

      <h2 class="products-page-title">Lista de Productos</h2>

      <div class="products-layout">
        <!-- LISTA DE PRODUCTOS -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-header-title">Productos Registrados</div>
              <div class="card-subtitle">
                Total: <span id="totalProductos">0</span> productos
              </div>
            </div>
            <div class="card-header-meta">
              칔ltima actualizaci칩n: <span id="lastUpdate">-</span>
            </div>
          </div>

          <div class="filters-row">
            <span>Filtrar por categor칤a:</span>
            <select id="filterCategoria">
              <option value="all">Todas</option>
            </select>
          </div>

          <table class="products-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Categor칤a</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="productsTbody">
              <!-- filas generadas por JS -->
            </tbody>
          </table>

          <div class="pagination">
            <button class="btn btn-outline btn-sm" id="btnPrevPage">Anterior</button>
            <span id="paginationInfo">P치gina 1 de 1</span>
            <button class="btn btn-outline btn-sm" id="btnNextPage">Siguiente</button>
          </div>
        </section>

        <!-- PANEL INFO / AYUDA -->

      </div>
    </main>
  </div>

  <!-- MODAL CREAR / EDITAR PRODUCTO -->
  <div id="productModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div id="modalTitle" class="modal-title">Nuevo Producto</div>
          <div id="modalSubtitle" class="modal-description">
            Completa los datos del producto.
          </div>
        </div>
        <button class="modal-close" type="button" id="btnCloseModal">&times;</button>
      </div>

      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productoId" />

          <div class="form-grid">
            <div class="form-field">
              <label for="nombreProducto">Nombre</label>
              <input type="text" id="nombreProducto" required placeholder="Ej: Alternador Toyota" />
            </div>
            <div class="form-field">
              <label for="precioProducto">Precio (S/)</label>
              <input type="number" step="0.01" min="0" id="precioProducto" required placeholder="0.00" />
            </div>
            <div class="form-field">
              <label for="stockProducto">Stock</label>
              <input type="number" min="0" id="stockProducto" required placeholder="0" />
            </div>
            <div class="form-field">
              <label for="categoriaSelect">Categor칤a</label>
              <select id="categoriaSelect" required>
                <option value="">Seleccione categor칤a</option>
              </select>
            </div>
            <div class="form-field" style="grid-column: 1 / -1;">
              <label for="descripcionProducto">Descripci칩n</label>
              <textarea id="descripcionProducto" rows="3" placeholder="Detalle del producto..."></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-ghost btn-sm" id="btnCancelModal">Cancelar</button>
            <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // === CONFIGURACI칍N API ===
    const API_BASE = 'http://localhost:3000'; // ajusta si tu backend est치 en otro host/puerto
    const API_PRODUCTOS = API_BASE + '/productos';
    const API_CATEGORIAS = API_BASE + '/categorias'; // asunci칩n

    const PAGE_SIZE = 10;

    // === ESTADO DE FILTROS / PAGINACI칍N ===
    const state = {
      page: 1,
      search: '',
      categoriaId: 'all',
      total: 0
    };

    // === REFERENCIAS DOM ===
    const productsTbody = document.getElementById('productsTbody');
    const totalProductosSpan = document.getElementById('totalProductos');
    const lastUpdateSpan = document.getElementById('lastUpdate');

    const searchInput = document.getElementById('searchInput');
    const filterCategoriaSelect = document.getElementById('filterCategoria');

    const btnNewProduct = document.getElementById('btnNewProduct');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const paginationInfo = document.getElementById('paginationInfo');

    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancelModal = document.getElementById('btnCancelModal');

    const productForm = document.getElementById('productForm');
    const inputId = document.getElementById('productoId');
    const inputNombre = document.getElementById('nombreProducto');
    const inputPrecio = document.getElementById('precioProducto');
    const inputStock = document.getElementById('stockProducto');
    const inputDescripcion = document.getElementById('descripcionProducto');
    const selectCategoria = document.getElementById('categoriaSelect');

    let modalMode = 'create'; // 'create' | 'edit';
    let categorias = [];

    // === UTILIDADES ===
    function openModal(mode, producto) {
      modalMode = mode;

      if (mode === 'create') {
        modalTitle.textContent = 'Nuevo Producto';
        modalSubtitle.textContent = 'Completa los datos para registrar un nuevo producto.';
        productForm.reset();
        inputId.value = '';
      } else if (mode === 'edit' && producto) {
        modalTitle.textContent = 'Editar Producto';
        modalSubtitle.textContent = 'Actualiza los datos del producto seleccionado.';
        inputId.value = producto.id_producto;
        inputNombre.value = producto.nombre ?? '';
        inputPrecio.value = producto.precio ?? '';
        inputStock.value = producto.stock ?? '';
        inputDescripcion.value = producto.descripcion ?? '';
        selectCategoria.value = producto.categoria?.id_categoria ?? '';
      }

      productModal.classList.add('is-open');
    }

    function closeModal() {
      productModal.classList.remove('is-open');
    }

    function shortDateTime(date) {
      const d = new Date(date);
      if (Number.isNaN(d.getTime())) return '-';
      const h = d.getHours().toString().padStart(2, '0');
      const m = d.getMinutes().toString().padStart(2, '0');
      return `${d.toLocaleDateString()} ${h}:${m}`;
    }

    function productAvatar(nombre) {
      const n = (nombre || '').trim();
      if (!n) return 'P';
      return n.charAt(0).toUpperCase();
    }

    // === CATEGOR칈AS ===
    async function fetchCategorias() {
      try {
        const res = await fetch(API_CATEGORIAS, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem("token")}`,   // 游녣 AQU칈 se manda el token
          }
        });
        if (!res.ok) throw new Error('Error al cargar categor칤as');

        categorias = await res.json();

        // Rellenar select de filtro
        filterCategoriaSelect.innerHTML = '<option value="all">Todas</option>';
        categorias.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id_categoria;
          opt.textContent = cat.nombre;
          filterCategoriaSelect.appendChild(opt);
        });

        // Rellenar select del modal
        selectCategoria.innerHTML = '<option value="">Seleccione categor칤a</option>';
        categorias.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id_categoria;
          opt.textContent = cat.nombre;
          selectCategoria.appendChild(opt);
        });
      } catch (err) {
        console.warn('No se pudieron cargar categor칤as (verifica endpoint /categorias)', err);
      }
    }

    // === RENDER PRODUCTOS ===
    function renderProductos(items) {
      productsTbody.innerHTML = '';

      items.forEach(prod => {
        const tr = document.createElement('tr');
        tr.dataset.id = prod.id_producto;

        const categoriaNombre = prod.categoria?.nombre ?? 'Sin categor칤a';
        const stockClass = prod.stock <= 5 ? 'stock-low' : '';

        tr.innerHTML = `
        <td>
          <div class="product-cell">
            <div class="product-avatar">${productAvatar(prod.nombre)}</div>
            <div>
              <div class="product-name">${prod.nombre ?? ''}</div>
              <div class="product-category">${prod.descripcion ?? ''}</div>
            </div>
          </div>
        </td>
        <td>
          <span class="badge-category">${categoriaNombre}</span>
        </td>
        <td class="price-cell">S/ ${(prod.precio ?? 0).toFixed ? prod.precio.toFixed(2) : Number(prod.precio || 0).toFixed(2)}</td>
        <td class="${stockClass}">${prod.stock ?? 0}</td>
        <td>
          <div class="cell-actions">
            <button type="button" class="btn btn-outline btn-sm btn-edit">Editar</button>
            <button type="button" class="btn btn-danger btn-sm btn-delete">Eliminar</button>
          </div>
        </td>
      `;

        productsTbody.appendChild(tr);
      });

      totalProductosSpan.textContent = state.total;
      lastUpdateSpan.textContent = shortDateTime(new Date());
    }

    // === PAGINACI칍N ===
    function updatePagination(skip, take, total) {
      state.total = total;
      const currentPage = Math.floor(skip / take) + 1;
      const totalPages = Math.max(1, Math.ceil(total / take));

      state.page = currentPage;
      paginationInfo.textContent = `P치gina ${currentPage} de ${totalPages}`;

      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    // === API ===
    async function fetchProductos() {
      try {
        const params = new URLSearchParams();
        params.set('skip', (state.page - 1) * PAGE_SIZE);
        params.set('take', PAGE_SIZE);

        let url;
        const hasSearch = state.search && state.search.trim() !== '';
        const hasCategoria = state.categoriaId !== 'all';

        if (hasSearch) {
          params.set('nombre', state.search.trim());
        }
        if (hasCategoria) {
          params.set('categorias', String(state.categoriaId));
        }

        if (hasSearch || hasCategoria) {
          url = `${API_PRODUCTOS}/filtrar?` + params.toString();
        } else {
          url = `${API_PRODUCTOS}?` + params.toString();
        }

        const res = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem("token")}`,   // 游녣 AQU칈 se manda el token

          }
        });
        if (!res.ok) throw new Error('Error al obtener productos');

        const data = await res.json();
        const items = data.items || [];
        const total = data.total ?? items.length;
        const skip = data.skip ?? 0;
        const take = data.take ?? PAGE_SIZE;

        renderProductos(items);
        updatePagination(skip, take, total);
      } catch (err) {
        console.error(err);
        alert('No se pudieron cargar los productos.');
      }
    }

    async function fetchProductoPorId(id) {
      const res = await fetch(`${API_PRODUCTOS}/${id}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem("token")}`,   // 游녣 AQU칈 se manda el token

        }
      });
      if (!res.ok) throw new Error('No se pudo obtener el producto');
      return res.json();
    }

    async function crearProducto(payload) {
      const res = await fetch(API_PRODUCTOS, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(localStorage.getItem("token") && { 'Authorization': `Bearer ${localStorage.getItem("token")}` }),
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al crear producto');
      }
      return res.json();
    }

    async function actualizarProducto(id, payload) {
      const res = await fetch(`${API_PRODUCTOS}/${id}`, {
        method: 'PUT',
        headers: { 
          'Content-Type': 'application/json',
          ...(localStorage.getItem("token") && { 'Authorization': `Bearer ${localStorage.getItem("token")}` }),

        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al actualizar producto');
      }
      return res.json();
    }

    async function eliminarProducto(id) {
      const res = await fetch(`${API_PRODUCTOS}/${id}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem("token")}`,   // 游녣 AQU칈 se manda el token

          }
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Error al eliminar producto');
      }
      return res.json();
    }

    // === EVENTOS ===

    // Abrir modal nuevo producto
    btnNewProduct.addEventListener('click', () => openModal('create'));

    // Cerrar modal
    btnCloseModal.addEventListener('click', closeModal);
    btnCancelModal.addEventListener('click', closeModal);

    productModal.addEventListener('click', (e) => {
      if (e.target === productModal) closeModal();
    });

    // Submit formulario producto
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        nombre: inputNombre.value.trim(),
        descripcion: inputDescripcion.value.trim(),
        precio: Number(inputPrecio.value),
        stock: Number(inputStock.value),
        categoria: {id_categoria:selectCategoria.value},
      };

      if (!payload.nombre || Number.isNaN(payload.precio)) {
        alert('Completa los campos obligatorios.');
        return;
      }

      try {
        if (modalMode === 'create') {
          await crearProducto(payload);
        } else if (modalMode === 'edit') {
          await actualizarProducto(inputId.value, payload);
        }

        closeModal();
        await fetchProductos();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Error al guardar el producto.');
      }
    });

    // Click en editar / eliminar (delegado)
    productsTbody.addEventListener('click', async (e) => {
      const row = e.target.closest('tr');
      if (!row) return;
      const id = row.dataset.id;

      if (e.target.classList.contains('btn-edit')) {
        try {
          const producto = await fetchProductoPorId(id);
          openModal('edit', producto);
        } catch (err) {
          console.error(err);
          alert('No se pudo cargar la informaci칩n del producto.');
        }
      }

      if (e.target.classList.contains('btn-delete')) {
        const ok = confirm('쯉eguro que deseas eliminar este producto?');
        if (!ok) return;
        try {
          await eliminarProducto(id);
          await fetchProductos();
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar el producto.');
        }
      }
    });

    // B칰squeda
    let searchTimeout = null;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.search = searchInput.value;
        state.page = 1;
        fetchProductos();
      }, 300);
    });

    // Filtro categor칤a
    filterCategoriaSelect.addEventListener('change', () => {
      state.categoriaId = filterCategoriaSelect.value;
      state.page = 1;
      fetchProductos();
    });

    // Paginaci칩n
    btnPrevPage.addEventListener('click', () => {
      if (state.page > 1) {
        state.page -= 1;
        fetchProductos();
      }
    });

    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(state.total / PAGE_SIZE));
      if (state.page < totalPages) {
        state.page += 1;
        fetchProductos();
      }
    });

    // === INICIALIZAR ===
    fetchCategorias();
    fetchProductos();
  </script>
  <script src="./components/sidebar.js"></script>
</body>

</html>